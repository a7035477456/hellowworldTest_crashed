# HAProxy config for xbox2 (192.168.222.202) - round-robin load balancer
# Topology: xbox1 = Primary Postgres (192.168.222.201, DB only, not in pool)
#           xbox2 = this HAProxy server (192.168.222.202)
#           xbox3..xbox7 = webservers (replica DB + fe/be), port 40000
# SSL termination at HAProxy; backend webservers run HTTP on port 40000.

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    user haproxy
    group haproxy
    daemon
    nbthread 8
    maxconn 50000
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option http-keep-alive
    option redispatch
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout http-request 10s
    timeout http-keep-alive 10s
    balance roundrobin

# HTTP (80) -> redirect to HTTPS
# Cloudflare-only: deny direct IP; copy cloudflare-ips-v4.txt and cloudflare-ips-v6.txt to /etc/haproxy/
frontend fe_http
    bind *:80
    acl from_cloudflare src -f /etc/haproxy/cloudflare-ips-v4.txt
    acl from_cloudflare_v6 src -f /etc/haproxy/cloudflare-ips-v6.txt
    http-request deny if !from_cloudflare !from_cloudflare_v6
    http-request redirect scheme https code 301 unless { ssl_fc }

# HTTPS (443) - TLS termination; certificate path for Ubuntu
frontend fe_https
    bind *:443 ssl crt /etc/haproxy/certs/site.pem
    acl from_cloudflare src -f /etc/haproxy/cloudflare-ips-v4.txt
    acl from_cloudflare_v6 src -f /etc/haproxy/cloudflare-ips-v6.txt
    http-request deny if !from_cloudflare !from_cloudflare_v6
    option forwardfor
    http-request set-header X-Forwarded-Proto https
    default_backend be_nginx

# NGINX login layer (optional; single local instance)
backend be_nginx
    balance roundrobin
    server local_nginx 127.0.0.1:41000 check

# Internal frontend for NGINX callback -> web_pool
frontend fe_web
    bind 127.0.0.1:50000
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Forwarded-Proto https
    default_backend web_pool

# Application backend: webservers xbox3..xbox7 (PM2 on port 40000, replica DB on each)
backend web_pool
    balance roundrobin
    option httpchk GET /health
    http-check expect rstatus (2|3)[0-9][0-9]
    server xbox3 192.168.222.203:40000 check
    server xbox4 192.168.222.204:40000 check
    server xbox5 192.168.222.205:40000 check
    server xbox6 192.168.222.206:40000 check
    server xbox7 192.168.222.207:40000 check

# Stats UI (optional)
listen stats
    bind *:9900
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE

# HAProxy config: load balancer for currentProject2 (from originalProject1 setup)
# SSL termination at HAProxy; backend servers (xbox3..xbox9) run HTTP on port 40000.
# Adjust server list to xbox1..xbox6 or your actual hosts as needed.

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    user haproxy
    group haproxy
    daemon
    nbthread 8
    maxconn 50000
    tune.ssl.default-dh-param 2048

defaults
    mode http
    log global
    option httplog
    option http-keep-alive
    option redispatch
    timeout connect 5s
    timeout client 60s
    timeout server 60s
    timeout http-request 10s
    timeout http-keep-alive 10s
    balance roundrobin

# HTTP (80) -> redirect to HTTPS
frontend fe_http
    bind *:80
    http-request redirect scheme https code 301 unless { ssl_fc }

# HTTPS (443) - TLS termination; certificate path for Ubuntu
frontend fe_https
    bind *:443 ssl crt /etc/haproxy/certs/site.pem
    option forwardfor
    http-request set-header X-Forwarded-Proto https
    default_backend be_nginx

# NGINX login layer (optional; single local instance)
backend be_nginx
    balance roundrobin
    server local_nginx 127.0.0.1:41000 check

# Internal frontend for NGINX callback -> web_pool
frontend fe_web
    bind 127.0.0.1:50000
    mode http
    option forwardfor
    http-request set-header X-Forwarded-Host % [req.hdr(Host)]
    http-request set-header X-Forwarded-Proto https
    default_backend web_pool

# Application backend: PM2 instances on each webserver (port 40000)
# Original used xbox3,xbox4,xbox5,xbox7,xbox8,xbox9; change to xbox1..xbox6 if desired.
backend web_pool
    balance roundrobin
    option httpchk GET /
    http-check expect rstatus (2|3)[0-9][0-9]
    server xbox3 192.168.222.203:40000 check
    server xbox4 192.168.222.204:40000 check
    server xbox5 192.168.222.205:40000 check
    server xbox7 192.168.222.207:40000 check
    server xbox8 192.168.222.208:40000 check
    server xbox9 192.168.222.209:40000 check

# Stats UI (optional)
listen stats
    bind *:9900
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
